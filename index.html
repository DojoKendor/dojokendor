<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>DojoKendor · App</title><script src="https://unpkg.com/@supabase/supabase-js@2"></script><script src="https://unpkg.com/@zxing/library@latest"></script><script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script><script src="config.js?v=1"></script><style>:root{--bg:#0b1220;--card:#111827;--text:#e5e7eb;--border:#1f2937;--accent:#16a34a;--muted:#94a3b8}*{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:var(--text)}header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#0b1220}.brand{display:flex;gap:10px;align-items:center}.logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 120deg,#16a34a,#22d3ee,#ef4444)}.container{max-width:1100px;margin:18px auto;padding:0 12px;display:grid;gap:12px}.card{background:#111827;border:1px solid var(--border);border-radius:14px;padding:14px}input,button,select{background:#0b1220;color:#e5e7eb;border:1px solid var(--border);border-radius:10px;padding:10px}button.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#041007;font-weight:700;cursor:pointer}.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.hidden{display:none !important}.muted{color:var(--muted)}.meter{height:10px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}.meter>div{height:100%}.toast{position:fixed;right:12px;bottom:12px;padding:10px 12px;background:#0b1220;border:1px solid var(--border);border-radius:10px;display:none;z-index:50}.hr{border:0;border-top:1px solid var(--border);margin:12px 0}</style></head><body><header><div class="brand"><div class="logo"></div><b>DojoKendor</b></div><div class="row"><span id="badgeUser" class="muted hidden"></span><span id="badgeAdmin" class="muted hidden">· Admin</span><button id="btnLogout" class="hidden" onclick="logout()">Salir</button></div></header><main class="container"><section id="gate" class="card"><h3>Acceso</h3><div class="row"><button onclick="switchMode('login')">Entrar</button><button onclick="switchMode('signup')">Crear cuenta</button></div><div id="loginBox" class="row" style="margin-top:8px"><input id="emailLogin" type="email" placeholder="Correo"><input id="passLogin" type="password" placeholder="Contraseña"><button class="primary" onclick="signIn()">Entrar</button></div><div id="signupBox" class="row hidden" style="margin-top:8px"><input id="nameSignup" placeholder="Nombre de pila"><input id="emailSignup" type="email" placeholder="Correo"><input id="passSignup" type="password" placeholder="Contraseña"><input id="pass2Signup" type="password" placeholder="Confirmar"><button class="primary" onclick="signUp()">Crear cuenta</button></div></section><section id="welcome" class="card hidden"><h2>Bienvenido al Dojo Kendor</h2><p class="muted">Reseña del dojo. Al continuar, verás el menú principal.</p><button class="primary" onclick="goMenu()">Ir al menú</button></section><section id="menu" class="card hidden"><h3>Menú principal</h3><div class="row"><button onclick="openAttendance()">Mi asistencia</button><button onclick="openExercises()">Ejercicios del día</button><button onclick="openPayments()">Pagos</button><button onclick="openWall()">Muro</button><button onclick="openAdmin()" id="btnAdmin" class="hidden">Panel Admin</button></div></section><section id="attendance" class="card hidden"><h3>Asistencia</h3><p>Hola <b id="helloName">Alumno</b>. Marca tu asistencia o muestra tu código de barras para que el admin lo escanee.</p><div class="row"><input type="date" id="attDate"><button class="primary" onclick="markAttendance()">Marcar asistencia</button><button onclick="showCode()">Mostrar mi código</button></div><div id="attMsg" class="muted" style="margin-top:8px"></div><div id="barcodeBox" class="hidden" style="margin-top:6px"><svg id="myBarcode"></svg></div><hr class="hr"><h4>Escáner (Admin)</h4><div id="adminScanBox" class="hidden"><div class="row"><input type="date" id="scanDate"><button onclick="toggleScanner()" id="btnScan">Iniciar cámara</button></div><video id="preview" style="width:100%;max-width:500px;border:1px solid #1f2937;border-radius:8px;background:#000" playsinline></video><div id="scanLog" class="muted" style="max-height:120px;overflow:auto;margin-top:8px"></div><div class="row" style="margin-top:8px"><input id="manualEmail" placeholder="Email (manual)"><input type="date" id="manualDate"><button onclick="manualAttendance()">Marcar manual</button></div></div></section><section id="exercises" class="card hidden"><h3>Ejercicios del día (progreso)</h3><div id="tracks"></div></section><section id="payments" class="card hidden"><h3>Pagos</h3><div class="muted">Si tu pago vence y está pendiente, verás aviso aquí.</div><div id="payList" style="margin-top:8px"></div></section><section id="wall" class="card hidden"><h3>Muro del dojo</h3><div class="row"><input id="postText" placeholder="Anuncio o comentario"><input id="postLink" placeholder="Link (opcional)"><button onclick="createPost()">Publicar</button></div><div id="posts" style="margin-top:8px"></div></section><section id="admin" class="card hidden"><h3>Panel de administración</h3><div class="row"><input id="searchEmail" placeholder="Buscar alumno por email"><button onclick="findUser()">Buscar</button><span id="foundUser" class="muted hidden"></span></div><div class="row" style="margin-top:10px"><select id="progTrack"><option value="cardio_tumbling">Cardio y Tumbling</option><option value="olimpica">Olímpica</option><option value="grecorromana">Grecorromana</option><option value="lucha_libre">Lucha Libre</option><option value="ras_de_lona">A ras de Lona</option><option value="intercolegial">Intercolegial</option></select><input id="progPercent" type="number" min="0" max="100" placeholder="%"><button onclick="setProgress()">Guardar progreso</button></div><div class="row"><input id="payMonth" type="number" min="1" max="12" placeholder="Mes"><input id="payYear" type="number" min="2000" max="2100" placeholder="Año"><input id="payDue" type="number" min="1" max="28" placeholder="Día venc."><input id="payAmount" type="number" step="0.01" placeholder="Monto"><select id="payPaid"><option value="false">Pendiente</option><option value="true">Pagado</option></select><button onclick="upsertPayment()">Guardar pago</button></div><div class="row"><input id="guestName" placeholder="Nombre visitante"><select id="guestPaid"><option value="false">Sin pago</option><option value="true">Con pago</option></select><button onclick="addVisit()">Agregar visita</button></div><div class="row"><select id="userStatus"><option value="active">Activo</option><option value="inactive">Inactivo (baja)</option></select><button onclick="setUserStatus()">Guardar estado</button></div></section><div id="toast" class="toast"></div></main><script>
const supa = window.supabase.createClient(window.DOJO_SUPABASE_URL, window.DOJO_SUPABASE_ANON);
let sessionUser=null, isAdmin=false, foundUserId=null;
function show(id){ document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
function switchMode(mode){ document.getElementById('loginBox').classList.toggle('hidden', mode!=='login'); document.getElementById('signupBox').classList.toggle('hidden', mode!=='signup'); }
function goMenu(){ show('menu'); }
async function signUp(){ const name=document.getElementById('nameSignup').value.trim(); const email=document.getElementById('emailSignup').value.trim().toLowerCase(); const pass=document.getElementById('passSignup').value.trim(); const pass2=document.getElementById('pass2Signup').value.trim(); if(!email||!pass) return toast("Email y password requeridos"); if(pass!==pass2) return toast("No coinciden"); const { error } = await supa.auth.signUp({ email, password: pass }); if(error) return toast(error.message); toast("Cuenta creada. Entra con tus datos."); switchMode('login'); }
async function signIn(){ const email=document.getElementById('emailLogin').value.trim().toLowerCase(); const pass=document.getElementById('passLogin').value.trim(); const { data, error } = await supa.auth.signInWithPassword({ email, password: pass }); if(error) return toast(error.message); sessionUser = data.user; document.getElementById('badgeUser').textContent=sessionUser.email; document.getElementById('badgeUser').classList.remove('hidden'); document.getElementById('btnLogout').classList.remove('hidden'); await refreshRole(); try{ const { data: pr } = await supa.from('profiles').select('display_name').eq('id', sessionUser.id).single(); document.getElementById('helloName').textContent = pr?.display_name || sessionUser.email.split('@')[0]; }catch(_){} show('welcome'); }
async function logout(){ await supa.auth.signOut(); sessionUser=null; isAdmin=false; foundUserId=null; document.getElementById('badgeUser').classList.add('hidden'); document.getElementById('badgeAdmin').classList.add('hidden'); document.getElementById('btnAdmin').classList.add('hidden'); document.getElementById('btnLogout').classList.add('hidden'); show('gate'); }
async function refreshRole(){ isAdmin=false; if(sessionUser?.email){ const { data:rows } = await supa.from('admins').select('email').eq('email', sessionUser.email); isAdmin = rows && rows.length>0; } document.getElementById('badgeAdmin').classList.toggle('hidden', !isAdmin); document.getElementById('adminScanBox').classList.toggle('hidden', !isAdmin); document.getElementById('btnAdmin').classList.toggle('hidden', !isAdmin); }
function isTrainingISO(iso){ const d=new Date(iso+'T00:00:00'); const w=(d.getDay()+6)%7+1; return [2,3,4].includes(w); }
function openAttendance(){ if(!sessionUser) return toast("Inicia sesión"); document.getElementById('attDate').valueAsDate=new Date(); show('attendance'); }
async function markAttendance(){ const iso=(document.getElementById('attDate').value||new Date().toISOString().slice(0,10)); if(!isTrainingISO(iso)) return toast("Sólo Mar/Mié/Jue"); const { error } = await supa.from('asistencia').insert({ user_id: sessionUser.id, class_date: iso, method: 'qr' }); if(error) return toast(error.message); document.getElementById('attMsg').textContent="Asistencia marcada para "+iso; toast("Asistencia ✓"); }
function showCode(){ if(!sessionUser) return; document.getElementById('barcodeBox').classList.remove('hidden'); const svg=document.getElementById('myBarcode'); svg.innerHTML=""; JsBarcode(svg, sessionUser.email, {format:"CODE128", lineColor:"#e5e7eb", background:"#0b1220", margin:10, width:2, height:100, displayValue:true}); }
let codeReader=null, scanning=false;
async function toggleScanner(){ if(!isAdmin) return toast("Sólo admin"); const btn=document.getElementById('btnScan'); const sd=document.getElementById('scanDate'); if(!sd.value) sd.valueAsDate=new Date(); const iso=sd.value; if(!isTrainingISO(iso)) return toast("Fecha debe ser Mar/Mié/Jue"); const preview=document.getElementById('preview'), log=document.getElementById('scanLog'); if(scanning){ scanning=false; if(codeReader){codeReader.reset(); codeReader=null;} btn.textContent="Iniciar cámara"; return; } scanning=true; btn.textContent="Detener cámara"; log.innerHTML=""; try{ codeReader=new ZXing.BrowserMultiFormatReader(); const devices=await ZXing.BrowserCodeReader.listVideoInputDevices(); const deviceId=(devices[0]&&devices[0].deviceId)||null; await codeReader.decodeFromVideoDevice(deviceId, preview, async (result, err)=>{ if(result){ const email=(result.text||'').trim().toLowerCase(); const { data: pr } = await supa.from('profiles').select('id').eq('email', email).limit(1); if(!pr||pr.length===0){ log.innerHTML+=`<div>No registrado: ${email}</div>`; return; } const uid=pr[0].id; const { error:e2 } = await supa.from('asistencia').insert({ user_id: uid, class_date: iso, method: 'manual' }); if(e2){ log.innerHTML+=`<div style="color:#ef4444">Error: ${e2.message}</div>`; } else { log.innerHTML+=`<div>✓ Marcada: ${email} · ${iso}</div>`; } } }); }catch(ex){ console.error(ex); toast("No se pudo abrir la cámara"); } }
async function manualAttendance(){ if(!isAdmin) return; const email=(document.getElementById('manualEmail').value||'').trim().toLowerCase(); const iso=(document.getElementById('manualDate').value||new Date().toISOString().slice(0,10)); if(!isTrainingISO(iso)) return toast("Fecha debe ser Mar/Mié/Jue"); const { data: pr } = await supa.from('profiles').select('id').eq('email', email).limit(1); if(!pr||pr.length===0) return toast("No registrado"); const uid=pr[0].id; const { error } = await supa.from('asistencia').insert({ user_id: uid, class_date: iso, method: 'manual' }); if(error) return toast(error.message); toast("Asistencia manual ✓"); }
const TRACKS=[{key:'cardio_tumbling',label:'Cardio y Tumbling'},{key:'olimpica',label:'Olímpica'},{key:'grecorromana',label:'Grecorromana'},{key:'lucha_libre',label:'Lucha Libre'},{key:'ras_de_lona',label:'A ras de Lona'},{key:'intercolegial',label:'Intercolegial'}];
function colorFor(p){ if(p<=20) return 'red'; if(p<=41) return 'gold'; if(p<=63) return 'orange'; if(p<=75) return 'deepskyblue'; if(p<=90) return 'limegreen'; return 'black'; }
function openExercises(){ show('exercises'); renderTracks(); }
async function renderTracks(){ const box=document.getElementById('tracks'); box.innerHTML=""; if(!sessionUser){ box.innerHTML="<div class='muted'>Inicia sesión</div>"; return; } const { data } = await supa.from('user_progress').select('track, percent').eq('user_id', sessionUser.id); const map={}; (data||[]).forEach(r=>map[r.track]=r.percent); TRACKS.forEach(t=>{ const p=map[t.key]??0; const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.innerHTML=`<div style="min-width:220px"><b>${t.label}</b></div><div class="meter" style="flex:1;margin:0 8px"><div style="width:${p}%; background:${colorFor(p)}"></div></div><div style="min-width:50px;text-align:right">${p}%</div>`; box.appendChild(row); }); }
function openPayments(){ show('payments'); loadPayments(); }
async function loadPayments(){ if(!sessionUser){ document.getElementById('payList').innerHTML=''; return; } const { data } = await supa.from('pagos').select('*').eq('user_id', sessionUser.id).order('period_year',{ascending:false}).order('period_month',{ascending:false}).limit(24); const box=document.getElementById('payList'); box.innerHTML=""; (data||[]).forEach(row=>{ const dueDate=new Date(row.period_year,row.period_month-1,row.due_day); const overdue=!row.paid && dueDate<new Date(); const div=document.createElement('div'); div.className='row'; div.style.cssText='justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:6px'; div.innerHTML=`<div>${row.period_month}/${row.period_year} · vence día ${row.due_day}</div><div>${row.paid?'Pagado ✅':(overdue?'Vencido ⚠️':'Pendiente')}</div>`; box.appendChild(div); }); }
function openWall(){ show('wall'); loadPosts(); }
async function createPost(){ if(!sessionUser) return toast("Inicia sesión"); const text=(document.getElementById('postText').value||'').trim(); const link=(document.getElementById('postLink').value||'').trim(); if(!text) return; const { error } = await supa.from('posts').insert({ author_id: sessionUser.id, content: text, link }); if(error) return toast(error.message); document.getElementById('postText').value=''; document.getElementById('postLink').value=''; loadPosts(); }
async function loadPosts(){ const box=document.getElementById('posts'); box.innerHTML=""; const { data: posts } = await supa.from('posts').select('id, content, link, created_at').order('created_at',{ascending:false}).limit(30); for(const p of (posts||[])){ const row=document.createElement('div'); row.className='card'; row.style.marginBottom='8px'; row.innerHTML = `<div>${p.content}</div>${p.link? `<div><a href="${p.link}" target="_blank">${p.link}</a></div>`:''}<div class="muted" style="font-size:12px">${new Date(p.created_at).toLocaleString()}</div><div class="row"><input placeholder="Responder..." id="reply_${p.id}"><button onclick="replyPost('${p.id}')">Enviar</button></div><div id="replies_${p.id}" class="muted" style="margin-top:6px"></div>`; box.appendChild(row); const { data: reps } = await supa.from('post_replies').select('content, created_at').eq('post_id', p.id).order('created_at',{ascending:true}); const rbox=document.getElementById('replies_'+p.id); (reps||[]).forEach(r=>{ const d=document.createElement('div'); d.textContent='• '+r.content+' — '+new Date(r.created_at).toLocaleTimeString(); rbox.appendChild(d); }); } }
async function replyPost(id){ if(!sessionUser) return; const inp=document.getElementById('reply_'+id); const txt=(inp.value||'').trim(); if(!txt) return; const { error } = await supa.from('post_replies').insert({ post_id:id, author_id: sessionUser.id, content: txt }); if(error) return toast(error.message); inp.value=''; loadPosts(); }
function openAdmin(){ if(!isAdmin) return toast("Sólo admin"); show('admin'); }
async function findUser(){ const email=(document.getElementById('searchEmail').value||'').trim().toLowerCase(); if(!email) return; const { data } = await supa.from('profiles').select('id,email,display_name,status').eq('email', email).limit(1); const badge=document.getElementById('foundUser'); if(!data||data.length===0){ foundUserId=null; badge.textContent='No encontrado'; badge.classList.remove('hidden'); return; } foundUserId=data[0].id; badge.textContent=(data[0].display_name||'')+' · '+data[0].email+' · '+(data[0].status||''); badge.classList.remove('hidden'); }
async function setProgress(){ if(!isAdmin||!foundUserId) return toast("Busca alumno primero"); const track=document.getElementById('progTrack').value; const percent=parseInt(document.getElementById('progPercent').value||'0',10); const { error } = await supa.from('user_progress').upsert({ user_id:foundUserId, track, percent }, { onConflict:'user_id,track' }); if(error) return toast(error.message); toast("Progreso guardado ✓"); }
async function upsertPayment(){ if(!isAdmin||!foundUserId) return toast("Busca alumno primero"); const m=parseInt(document.getElementById('payMonth').value||'0',10); const y=parseInt(document.getElementById('payYear').value||'0',10); const due=parseInt(document.getElementById('payDue').value||'5',10); const amount=parseFloat(document.getElementById('payAmount').value||'0'); const paid=document.getElementById('payPaid').value==='true'; if(!(m>=1&&m<=12&&y>=2000)) return toast("Mes/Año inválidos"); let payload={ user_id:foundUserId, period_month:m, period_year:y, due_day:due, amount, paid }; if(paid) payload.paid_at=new Date().toISOString(); const { error } = await supa.from('pagos').insert(payload); if(error){ return toast(error.message); } toast("Pago guardado ✓"); }
async function addVisit(){ if(!isAdmin) return; const name=(document.getElementById('guestName').value||'').trim(); const paid=document.getElementById('guestPaid').value==='true'; if(!name) return; const { error } = await supa.from('visits').insert({ name, paid }); if(error) return toast(error.message); document.getElementById('guestName').value=''; toast("Visita registrada ✓"); }
async function setUserStatus(){ if(!isAdmin||!foundUserId) return toast("Busca alumno primero"); const status=document.getElementById('userStatus').value; const { error } = await supa.from('profiles').update({ status }).eq('id', foundUserId); if(error) return toast(error.message); toast("Estado actualizado ✓"); }
supa.auth.onAuthStateChange((_e,_s)=>boot());
async function boot(){ const { data } = await supa.auth.getUser(); sessionUser=data.user||null; if(sessionUser){ document.getElementById('badgeUser').classList.remove('hidden'); document.getElementById('badgeUser').textContent=sessionUser.email; document.getElementById('btnLogout').classList.remove('hidden'); await refreshRole(); show('welcome'); } else { show('gate'); } }
</script></body></html>